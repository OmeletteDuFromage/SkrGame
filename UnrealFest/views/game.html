<!DOCTYPE html>
<html class="background-image-container" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyreal UnrealFest 2024</title>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <img src="/images/rotate_screen.svg" id="fullscreenImage" class="fullscreen-image">
    
    <div id="end-page" class="end-page">
        <img id="end-image">
    </div>

    <div id="main-container" class="grid-container">
        <div class="score-container">
            <img id="team-icon" alt="portrait" class="top-right-image">
            <svg id="percentage-svg" width="100%" height="100%" viewBox="0 0 100 100"
                xmlns="http://www.w3.org/2000/svg">
                <text id="percentage-text" x="50%" y="50%" dominant-baseline="middle">
                    0%
                </text>
            </svg>
        </div>
        <img src="/images/black_bg.svg" alt="Black background" class="image-bottom">
        <div id="zone" class="zone-container">
            <img id="image-plane" src="/images/plane_top.svg" alt="Border" usemap="#imagemap" class="image-plane">
            <map name="imagemap" class="image-map-map" id="image-map-map"></map>
        </div>
        <img src="/images/text_rules.png" alt="Top Left Image" class="top-left-image">
        <button id="bottom-right-button" class="bottom-right-button">
            <img src="/images/switch_view.svg" alt="Button Image">
        </button>
    </div>
</body>
<style>
    #percentage-svg {
        position: absolute;
        top: 20px;
        /* Adjust as needed */
        right: 20px;
        /* Adjust as needed */
        width: 150px;
        /* Adjust as needed */
        height: 150px;
        /* Adjust as needed */
        color: white;
        fill: white;
        text-anchor: middle;
        font-size: 100;
        font-weight: bolder;
        z-index: 100;
    }

    body,
    html {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        height: 100%;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        /* Prevent scrolling */
    }

    .grid-container {
        height: 100%;
        width: 100%;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        /* Adjust for better responsiveness */
    }

    .zone-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 2;
    }

    .fullscreen-image {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-image: url('images/background.svg');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 9999;
        display: none;
    }

    .top-right-image {
        position: absolute;
        top: 10px;
        right: 10px;
        max-width: 20%;
        height: auto;
        z-index: 5;
        background-color: transparent;
    }

    .image-map-map .image-plane {
        position: absolute;
        height: 100%;
        width: 100%;
        top: 0;
        left: 0;
    }

    .background {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f0f0f0;
        z-index: -1;
    }

    .image-container {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        width: 100vw;
        padding: 20px;
        box-sizing: border-box;
    }

    .image-container img {
        max-width: 100%;
        height: auto;
    }

    .image-bottom {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
        object-fit: cover;
        /* Ensure the image covers the entire area */
    }

    .image-top {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        object-fit: cover;
        /* Ensure the image covers the entire area */
    }

    .top-left-image {
        position: absolute;
        top: 4%;
        left: 4%;
        max-width: 20%;
        height: auto;
        z-index: 4;
    }

    .bottom-right-button {
        position: absolute;
        bottom: 4%;
        right: 1%;
        padding: 10px 20px;
        background-color: transparent;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        height: auto;
    }

    @media (orientation: landscape) {
        .top-right-image {
            top: 10px;
            right: 10px;
            max-width: 10%;
        }

        .body {
            width: auto;
            height: auto;
        }

        .top-left-image {
            max-width: 30%;
        }

        .bottom-right-button {
            bottom: 4%;
            right: 1%;
            background-color: transparent;
        }

        .landscape-only {
            display: block;
        }
    }
</style>

</html>



<script>
    const socket = io();
    let cookies;
    socket.on('connect', () => {
        console.log('Connected to the server');
    });

    socket.on('ScoreUpdated', (data) => {
        message = JSON.parse(data);
        let score = 0;
        message.Zones.forEach(zone => {
            if (zone.WinningTeam === cookies.team)
            {
                score++;   
            }
        });
        const score_final = Math.round((score * 100) / message.Zones.length);
        console.log("final : " + score_final)
        updatePercentage(score_final)
    });

    socket.on('OnGameTerminated', (data) => {
        // message = JSON.stringify(message);
        elem = document.getElementById("main-container");
        page = document.getElementById("end-page");
        img = document.getElementById("end-image");

        const jsonString = '[{"UserId":"1F092FBF48F4A023F11718B623A33BA6","ClickCount":1},{"UserId":"B53FA9564481EC677E79698CC8040D3F","ClickCount":0},{"UserId":"F38534F04A18388728F522A255C07323","ClickCount":0},{"UserId":"B2AC2EF34E0F40798D1C1B97718FE024","ClickCount":0},{"UserId":"343DA5DA43B507B38062198E3C7AF88C","ClickCount":0},{"UserId":"B01AB1E14C859EC197A642A5F042C8D3","ClickCount":1},{"UserId":"70D4457342B92F653F01F0AF2D3C16F9","ClickCount":2},{"UserId":"612626EB4C3448206846169124E735D5","ClickCount":3},{"UserId":"2283DF05491E382B6D8DD5BE8AB0C27","ClickCount":1},{"UserId":"A8A6A3D24300FE4CA12CCBB5CCF6514D","ClickCount":0},{"UserId":"F3DA924E40FE6DB42164A7B12D996A16","ClickCount":1},{"UserId":"D58F940F487062D47266769AB011B8D2","ClickCount":2},{"UserId":"E15D8CFC4A48BB8346DFFC9D47A6C8EE","ClickCount":0},{"UserId":"BF1B6968468212FA4C7B0B80C1B7A012","ClickCount":0},{"UserId":"3B50341E43A7BAF926702FBD615658DE","ClickCount":0},{"UserId":"1EB5CFBF4388F877B2F9C3B39FE835F5","ClickCount":2},{"UserId":"16437BF441EBDBF630AEDEBD9AB1CA9D","ClickCount":2},{"UserId":"FB254EE64AC3A831EA57CEA3465C9A59","ClickCount":3},{"UserId":"C3AD0A484B3AB8C4D42BA0AB5AC49619","ClickCount":2},{"UserId":"7D5E2FCC432B5E531F9776B3E03BB330","ClickCount":1},{"UserId":"BCAF094A4CF7095CE767908B72A99B9C","ClickCount":0},{"UserId":"7065EED3416A6C58D2EF9FB78A5DC92D","ClickCount":3},{"UserId":"C4B9CE7B4A37816C9EC4B39AF86A6673","ClickCount":0}]';
        const message = JSON.parse(jsonString);
        res = message.find(t => t.UserId == cookies.UserId)
        elem.style.display = "none"
        
        page.style.position = "fixed";
        page.style.display = "flex";
        page.style.height = "100%";
        page.style.width = "100%";
        page.style.justifyContent = "center";
        page.style.alignItems = "center";
        
        page.style.top = 0;
        page.style.left = 0;
        page.style.height = "100%";
        page.style.width = "100%";
        
        // if (cookies.team == message.WinningTeam)
        // {
            //     img.src = "/images/win.svg"
            // page.style.backgroundImage = "url('/images/background.svg')";
        // }
        // else
        // {
        //     img.src = "/images/loose.svg"
        // }

        img.src = "/images/win.svg"
        const container = document.createElement('div');

        img.parentNode.insertBefore(container, img);
        container.appendChild(img);
    });

    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function updatePercentage(percentage) {
        const svgText = document.getElementById('percentage-text');
        svgText.textContent = `${percentage}%`;

        // Optionally, adjust the font size based on the percentage
        const fontSize = 30; // Example scaling
        svgText.setAttribute('font-size', fontSize);
    }


    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
            });
        } else {
            document.exitFullscreen();
        }
    }

    function checkOrientation() {
        if (window.innerHeight > window.innerWidth) {
            document.getElementById('fullscreenImage').style.display = 'block';
            document.querySelector('.grid-container').style.display = 'none';
        } else {
            document.getElementById('fullscreenImage').style.display = 'none';
            document.querySelector('.grid-container').style.display = 'block';
        }
    }

    function GetAreas() {
        const image_map = document.getElementById("image-plane")
        let areas;
        if (image_map.src.includes('side')) {
            areas = [
                { coords: [52, 185, 237, 252], alt: "Rocket Engine" },
                { coords: [93, 108, 237, 185], alt: "Vertical Tail Plane" },
                { coords: [238, 186, 359, 244], alt: "Oxygen Tank" },
                { coords: [238, 243, 443, 267], alt: "Fuel Tank" },
                { coords: [360, 186, 443, 243], alt: "Methan Tank" },
                { coords: [444, 186, 532, 246], alt: "Cabine" },
                { coords: [532, 186, 577, 246], alt: "Cockpit" },
                { coords: [577, 186, 636, 246], alt: "Nose" }
            ];
        }
        else {
            areas = [
                { coords: [154, 159, 186, 217], alt: "Rocket Engine" },
                { coords: [188, 106, 228, 270], alt: "Horizontal Tail Plane" },
                { coords: [215, 145, 301, 189], alt: "Jet Engine Left" },
                { coords: [214, 190, 301, 233], alt: "Jet Engine Right" },
                { coords: [280, 167, 341, 37], alt: "Left Wing" },
                { coords: [276, 213, 341, 343], alt: "Right Wing" },
                { coords: [301, 168, 341, 210], alt: "Fuel Tank" },
                { coords: [341, 168, 427, 218], alt: "Methan tank" },
                { coords: [428, 159, 473, 218], alt: "Cabine" },
                { coords: [474, 159, 500, 218], alt: "Cockpit" },
                { coords: [499, 159, 542, 218], alt: "Nose" }
            ];
        }
        return areas;
    }

    const originalWidth = 667;
    const originalHeight = 375;
    function scaleCoords(coords, scaleX, scaleY) {
        return coords.map((coord, index) => {
            return index % 2 === 0 ? Math.round(coord * scaleX) : Math.round(coord * scaleY);
        });
    }

    function getScaleFactors(element, originalWidth, originalHeight) {
        const rect = element.getBoundingClientRect();
        const scaleX = rect.width / originalWidth;
        const scaleY = rect.height / originalHeight;
        return { scaleX, scaleY };
    }

    function updateMapAreas() {
        checkOrientation()
        const imageMapElement = document.getElementById('image-plane');
        const originalWidth = 667;
        const originalHeight = 375;

        const { scaleX, scaleY } = getScaleFactors(imageMapElement, originalWidth, originalHeight);
        const mapElement = document.getElementById('image-map-map');

        mapElement.innerHTML = ''; // Clear existing areas


        GetAreas().forEach(area => {
            const scaledCoords = scaleCoords(area.coords, scaleX, scaleY).join(',');
            const areaElement = document.createElement('area');
            areaElement.shape = 'rect';
            areaElement.coords = scaledCoords;
            areaElement.alt = area.alt;
            areaElement.href = '#';
            areaElement.onclick = () => zoneClicked(area.alt);
            mapElement.appendChild(areaElement);
        });
    }

    function zoneClicked(ZoneName) {
        fetch('/button-click', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ buttonId: ZoneName })
        })
            .then(response => {
                if (response.ok) {
                } else {
                    console.error('Error sending button click event');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });


    }

    window.addEventListener('resize', updateMapAreas);
    window.addEventListener('load', () => {
        const img = document.getElementById('image-plane');
        if (img.complete) {
            updateMapAreas();
        } else {
            img.onload = updateMapAreas;
        }
    });
    const switch_view_button = document.getElementById('bottom-right-button')
    switch_view_button.addEventListener('click', async (event) => {
        const image_plane = document.getElementById("image-plane");
        if (image_plane.src.includes('side')) {
            image_plane.src = "/images/plane_top.svg";
        }
        else {
            image_plane.src = "/images/plane_side.svg";

        }
        updateMapAreas();
    });

    document.querySelectorAll('.grid-container area').forEach(area => {
        area.addEventListener('click', async (event) => {
            const areaId = event.target.id;
            try {
                const response = await fetch('/button-click', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ buttonId: areaId })
                });

                if (response.ok) {
                    const result = await response.text();
                    console.log(result);
                } else {
                    console.error('Error handling button click');
                }
            } catch (error) {
                console.error('Error sending AJAX request:', error);
            }
        });
    });
    document.addEventListener('DOMContentLoaded', (event) => {

        fetch('/get-cookie')
            .then(response => response.json())
            .then(data => {
                cookies = data;
                const teamicon = document.getElementById("team-icon");
                if (data.team == 0) {
                    teamicon.src = "/images/team_a_portrait.svg"
                }
                else {
                    teamicon.src = "/images/team_b_portrait.svg"
                }
            });
        window.addEventListener('resize', updateMapAreas);
        window.addEventListener('load', () => {
            const img = document.getElementById('image-plane');
            if (img.complete) {
                updateMapAreas();
            } else {
                img.onload = updateMapAreas;
            }
        });

    });

</script>